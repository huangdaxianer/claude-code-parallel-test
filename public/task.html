<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Details - ÊñπËàü‰ºóÊµãÂπ≥Âè∞</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/task.css">
    <link rel="stylesheet" href="css/comments.css">
    <!-- Highlight.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>

<body>
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <div class="app-layout" id="app-layout">
        <div class="sidebar-header">
            <button id="sidebar-toggle" class="icon-btn-ghost">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <div class="logo">
                <h1>ÊñπËàü‰ºóÊµãÂπ≥Âè∞</h1>
            </div>
        </div>

        <!-- User Info Bar - Dropdown Style -->
        <div id="user-info-bar" class="user-dropdown-container">
            <button class="user-dropdown-trigger" id="user-dropdown-trigger">üë§</button>
            <div class="user-dropdown-menu" id="user-dropdown-menu">
                <div class="user-dropdown-username">
                    <span id="username-display"></span>
                </div>
                <button class="user-dropdown-item" onclick="openChangePasswordModal()" style="display:block; width:100%; padding:0.5rem 1rem; border:none; background:none; text-align:left; font-size:0.9rem; color:#334155; cursor:pointer; border-bottom:1px solid #e2e8f0;" onmouseover="this.style.backgroundColor='#f1f5f9'" onmouseout="this.style.backgroundColor='transparent'">‰øÆÊîπÂØÜÁ†Å</button>
                <button class="user-dropdown-logout" onclick="logout()">ÈÄÄÂá∫ÁôªÂΩï</button>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">

            <button id="new-task-btn" class="btn-new-task">
                <span class="icon">+</span>
                <span class="text">Êñ∞Âª∫‰ªªÂä°</span>
            </button>

            <!-- GSB Entry Button (only visible for internal users) -->
            <button id="gsb-entry-btn" class="btn-gsb-entry" style="display: none;"
                onclick="window.location.href='/gsb.html'">
                <span class="icon">‚öñÔ∏è</span>
                <span class="text">ËøõÂÖ• GSB ËØÑÊµã</span>
            </button>

            <div class="task-history-list" id="task-history-list">
                <!-- History Items injected via JS -->
                <div style="padding:1rem; color:#94a3b8; font-size:0.8rem;">Loading...</div>
            </div>
        </aside>

        <!-- Main Content Area (Right Side) -->
        <!-- 3. Top Bar -->
        <header class="top-bar">



            <div id="model-list" class="model-list">
                <!-- Model tabs will be injected here -->
                <div style="padding: 1rem; color: #94a3b8; font-size: 0.9rem;">Loading...</div>
            </div>
        </header>

        <!-- 4. Main Content Area (Right Side) -->
        <div class="main-wrapper" id="main-content-wrapper">

            <!-- Statistics View -->
            <div id="statistics-view" class="statistics-view">
                <!-- Prompt Display Section -->
                <div class="stats-card" style="margin-bottom: 1.5rem; padding: 1.5rem;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                        <h3 style="margin:0; font-size:1rem; color:#1e293b;">Prompt</h3>
                        <button id="copy-prompt-btn" class="back-btn" onclick="copyPrompt()"
                            style="padding:0.4rem 0.6rem; font-size:0.8rem; display:flex; align-items:center; gap:0.4rem;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            Copy
                        </button>
                    </div>
                    <div id="task-prompt-display"
                        style="background:#f1f5f9; padding:1rem; border-radius:0.5rem; font-family:'Menlo',monospace; font-size:0.9rem; color:#334155; white-space:pre-wrap; max-height:300px; overflow-y:auto;">
                        Loading prompt...</div>
                </div>

                <div class="stats-card">
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>Ê®°ÂûãÂêçÁß∞</th>
                                <th>Áä∂ÊÄÅ</th>
                                <th>Êìç‰Ωú</th>
                                <th>ËÄóÊó∂</th>
                                <th>ËΩÆÊ¨°</th>
                                <th>TodoWrite</th>
                                <th>Read</th>
                                <th>Write</th>
                                <th>Bash</th>
                                <th>Input</th>
                                <th>Output</th>
                                <th>Cache Read</th>
                            </tr>
                        </thead>
                        <tbody id="stats-table-body">
                            <!-- Rows injected via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="comparison-view" class="comparison-view">
                <!-- Left Panel -->
                <div class="comparison-panel" id="comparison-left">
                    <div class="comparison-header">
                        <div class="comparison-model-list" id="select-left">
                            <!-- Model tabs injected here -->
                        </div>
                        <span id="status-left" class="status-badge" style="display:none"></span>
                    </div>
                    <div class="cmp-preview-status-bar" id="cmp-status-bar-left" style="display:none;">
                        <div style="display:flex;align-items:center;gap:0.5rem;">
                            <span class="cmp-status-dot" id="cmp-status-dot-left"></span>
                            <span class="cmp-status-text" id="cmp-status-text-left">Ready</span>
                        </div>
                        <div style="display:flex;gap:0.5rem;">
                            <button class="cmp-preview-btn" id="cmp-fullscreen-left" onclick="App.compare.openFullscreen('left')" style="display:none;">‚Üó ÂÖ®Â±èÊâìÂºÄ</button>
                            <button class="cmp-preview-btn" onclick="App.compare.restartPreview('left')">üîÑ ÈáçÂêØÊúçÂä°</button>
                        </div>
                    </div>
                    <div class="cmp-preview-logs" id="cmp-logs-left" style="display:none;"></div>
                    <div style="flex:1; position:relative; overflow:hidden;">
                        <iframe id="iframe-left" class="comparison-iframe"></iframe>
                        <div id="empty-left" class="empty-state" style="position:absolute; inset:0; background:white;">
                            <p>No preview available</p>
                        </div>
                    </div>
                </div>

                <!-- Right Panel -->
                <div class="comparison-panel" id="comparison-right">
                    <div class="comparison-header">
                        <div class="comparison-model-list" id="select-right">
                            <!-- Model tabs injected here -->
                        </div>
                        <span id="status-right" class="status-badge" style="display:none"></span>
                    </div>
                    <div class="cmp-preview-status-bar" id="cmp-status-bar-right" style="display:none;">
                        <div style="display:flex;align-items:center;gap:0.5rem;">
                            <span class="cmp-status-dot" id="cmp-status-dot-right"></span>
                            <span class="cmp-status-text" id="cmp-status-text-right">Ready</span>
                        </div>
                        <div style="display:flex;gap:0.5rem;">
                            <button class="cmp-preview-btn" id="cmp-fullscreen-right" onclick="App.compare.openFullscreen('right')" style="display:none;">‚Üó ÂÖ®Â±èÊâìÂºÄ</button>
                            <button class="cmp-preview-btn" onclick="App.compare.restartPreview('right')">üîÑ ÈáçÂêØÊúçÂä°</button>
                        </div>
                    </div>
                    <div class="cmp-preview-logs" id="cmp-logs-right" style="display:none;"></div>
                    <div style="flex:1; position:relative; overflow:hidden;">
                        <iframe id="iframe-right" class="comparison-iframe"></iframe>
                        <div id="empty-right" class="empty-state" style="position:absolute; inset:0; background:white;">
                            <p>No preview available</p>
                        </div>
                    </div>
                </div>
            </div>

            <main class="main-content" id="main-content">
                <div class="panel-single">
                    <div class="panel-header">
                        <div class="tabs">
                            <button class="tab active" data-tab="trajectory"
                                onclick="switchTab('trajectory')">ÊâßË°åËΩ®Ëøπ</button>
                            <button class="tab" data-tab="files" onclick="switchTab('files')">ÁîüÊàê‰∫ßÁâ©</button>
                            <button class="tab" data-tab="preview" onclick="switchTab('preview')"
                                style="display: none;">Âú®Á∫øÈ¢ÑËßà</button>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="action-btn" onclick="downloadFiles()" title="‰∏ãËΩΩÂΩìÂâç‰∫ßÁâ©">
                                <span>üì•</span> ‰∏ãËΩΩ‰∫ßÁâ©
                            </button>
                            <button class="action-btn" onclick="openIncrementalTaskModal()" title="Âü∫‰∫éÂΩìÂâçÁªìÊûúÁªßÁª≠ÂºÄÂèë">
                                <span>‚ú®</span> Â¢ûÈáèÂºÄÂèë
                            </button>

                        </div>
                    </div>

                    <!-- Trajectory Tab Content -->
                    <div id="tab-content-trajectory" class="tab-content active">
                        <div id="log-display" class="log-display">
                            <div class="empty-state">
                                <p style="margin-top: 1rem; font-size: 0.9rem;">ÊöÇÊó†ÊâßË°åËΩ®Ëøπ</p>
                            </div>
                        </div>
                    </div>

                    <!-- Files Tab Content -->
                    <div id="tab-content-files" class="tab-content">
                        <div id="file-list-container" class="file-list-container">
                            <ul id="file-list" class="file-list">
                                <!-- Files will be injected here -->
                            </ul>
                        </div>
                    </div>

                    <!-- Preview Tab Content -->
                    <div id="tab-content-preview" class="tab-content">
                        <div id="preview-status-bar" style="
                            padding: 0.5rem 1rem;
                            background: #f8fafc;
                            border-bottom: 1px solid #e2e8f0;
                            display: flex; /* Visible by default */
                            align-items: center;
                            justify-content: space-between;
                            font-size: 0.85rem;
                            color: #64748b;
                        ">
                            <div style="display:flex; align-items:center; gap:0.5rem;">
                                <span id="preview-status-dot" class="status-dot status-pending"
                                    style="background:#cbd5e1"></span>
                                <span id="preview-status-text">Ready</span>
                                <span id="preview-countdown"
                                    style="margin-left: 1rem; color: #64748b; font-size: 0.8rem; display: none;">(5:00)</span>
                            </div>
                            <div class="preview-actions" style="display:flex; gap:0.5rem;">
                                <button id="preview-url-display" onclick="openPreviewFullscreen()"
                                    style="display:none; border:1px solid #e2e8f0; background:white; cursor:pointer; padding:4px 8px; border-radius:6px; font-size:0.85rem; color:#475569; transition:all 0.2s; align-items:center; gap:4px;">
                                    ‚Üó ÂÖ®Â±èÊâìÂºÄ
                                </button>
                                <button onclick="reloadPreview()" title="Reload"
                                    style="border:1px solid #e2e8f0; background:white; cursor:pointer; padding: 4px 8px; border-radius: 6px; display: flex; align-items: center; gap: 4px; font-size: 0.85rem; color: #475569; transition: all 0.2s;">
                                    <span>üîÑ</span> ÈáçÊñ∞ÂêØÂä®ÊúçÂä°
                                </button>
                            </div>
                        </div>

                        <!-- Progress Overlay/List -->
                        <div id="preview-progress" style="
                            display: none;
                            padding: 0.5rem 1rem;
                            background: #fff;
                            border-bottom: 1px solid #e2e8f0;
                            height: 150px;
                            overflow-y: auto;
                            font-family: monospace;
                            font-size: 0.8rem;
                            color: #475569;
                        ">
                            <!-- Logs will be injected here -->
                        </div>

                        <iframe id="preview-iframe"
                            style="width:100%; height:calc(100% - 37px); border:none; background:#fff;"
                            allow="accelerometer; camera; encrypted-media; display-capture; geolocation; gyroscope; microphone; midi; clipboard-read; clipboard-write; web-share; serial; xr-spatial-tracking"
                            allowfullscreen allowpaymentrequest></iframe>
                    </div>
                </div>

                <!-- Feedback Sidebar (Now Inline) -->
                <div id="feedback-sidebar" class="feedback-sidebar">
                    <div class="feedback-header">
                        <div class="tabs">
                            <button class="tab active" data-tab="scoring"
                                onclick="App.feedback.switchTab('scoring')">ÊâìÂàÜËØÑ‰ª∑</button>
                            <button class="tab" data-tab="comments"
                                onclick="App.feedback.switchTab('comments')">ËØÑËÆ∫ÂèçÈ¶à</button>
                        </div>
                    </div>
                    <div id="feedback-body-scoring" class="feedback-body tab-content active">
                        <!-- Questions injected here -->
                        <div style="text-align:center; padding:2rem; color:#94a3b8;">Âä†ËΩΩ‰∏≠...</div>
                    </div>
                    <div id="feedback-body-comments" class="feedback-body tab-content">
                        <!-- ÂèçÈ¶àÂå∫Âüü -->
                        <div class="feedback-section">
                            <div class="feedback-section-header">
                                <span class="feedback-section-title">ÂèçÈ¶à</span>
                                <button id="add-feedback-btn" class="action-btn"
                                    onclick="App.comments.openFeedbackModal()">
                                    <span>‚ûï</span> Êñ∞Â¢ûÂèçÈ¶à
                                </button>
                            </div>
                            <div class="feedback-section-content">
                                <!-- Áî®Êà∑ÂèçÈ¶àÂàóË°® -->
                                <div id="user-feedback-list" class="user-feedback-list">
                                    <!-- User feedback will be rendered here -->
                                </div>
                            </div>
                        </div>

                        <!-- ËØÑËÆ∫Âå∫Âüü -->
                        <div class="feedback-section">
                            <div class="feedback-section-header">
                                <span class="feedback-section-title">ËØÑËÆ∫</span>
                                <!-- Êó†ËØÑËÆ∫Êó∂ÊòæÁ§∫ÁöÑÊèêÁ§∫ÊñáÂ≠ó -->
                                <span id="comment-empty-hint" class="comment-empty-hint">ÈÄâÊã©ËΩ®ËøπÊù•Ê∑ªÂä†ËØÑËÆ∫</span>
                                <!-- Á¥ßÂáëÂûãÈ´ò‰∫ÆÂºÄÂÖ≥ÔºàÊúâËØÑËÆ∫Êó∂ÊòæÁ§∫Ôºâ -->
                                <div id="highlight-toggle-wrapper" class="highlight-toggle-wrapper"
                                    style="display: none;">
                                    <span class="highlight-toggle-label">È´ò‰∫ÆÂéüÊñá</span>
                                    <label class="ios-switch-mini">
                                        <input type="checkbox" id="comment-highlight-toggle" checked
                                            onchange="App.comments.toggleHighlight(this.checked)">
                                        <span class="ios-switch-mini-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="feedback-section-content">
                                <div id="comments-list" class="comments-list">
                                    <!-- Comments will be rendered here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>




        </div>

        <!-- File Preview Modal -->
        <!-- File Preview Modal -->
        <div id="preview-modal" class="file-preview-modal">
            <div class="preview-content">
                <div class="preview-header">
                    <h3 id="preview-filename" style="margin:0; font-size:1rem; font-weight:600;">filename.txt</h3>
                    <button class="close-btn" onclick="closePreview()">&times;</button>
                </div>
                <pre id="preview-body" class="preview-body"></pre>
            </div>
        </div>

        <!-- New Task Modal -->
        <div id="new-task-modal" class="file-preview-modal">
            <div class="preview-content" style="width: 600px; height: auto; max-height: 90vh;">
                <div class="preview-header">
                    <h3>Êñ∞Âª∫‰ªªÂä°</h3>
                    <button class="close-btn" onclick="closeNewTaskModal()">√ó</button>
                </div>
                <div class="preview-body task-modal-body" style="overflow-y:auto;">
                    <div class="form-group">
                        <!-- Âçï‰ªªÂä°ËæìÂÖ•Âå∫Âüü -->
                        <div id="single-task-area">
                            <div class="textarea-container">
                                <textarea id="task-prompt" placeholder="ËØ∑ËæìÂÖ•‰ªªÂä°ÊèèËø∞..." rows="6"
                                    style="min-height:120px;"></textarea>
                            </div>
                        </div>

                        <!-- ÊâπÈáè‰ªªÂä°È¢ÑËßàÂå∫ÂüüÔºàÂàùÂßãÈöêËóèÔºâ -->
                        <div id="batch-preview-area" style="display:none;">
                            <div class="batch-preview-table-wrapper">
                                <table class="batch-preview-table">
                                    <thead>
                                        <tr>
                                            <th style="width:40px; text-align: center;"><input type="checkbox"
                                                    id="batch-select-all" checked title="ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâ"></th>
                                            <th>‰ªªÂä°ÊèèËø∞</th>
                                        </tr>
                                    </thead>
                                    <tbody id="batch-preview-tbody"></tbody>
                                </table>
                            </div>
                            <div class="batch-preview-header">
                                <span id="batch-task-count">Â∑≤Âä†ËΩΩ 0 ‰∏™‰ªªÂä°</span>
                                <button type="button" id="clear-batch-btn" class="btn-text">Ê∏ÖÈô§</button>
                            </div>
                        </div>

                        <!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ• -->
                        <input type="file" id="folder-input" webkitdirectory directory style="display:none">
                        <input type="file" id="csv-file-input" accept=".csv" style="display:none">

                        <!-- ‰∏ä‰º†ÊåâÈíÆÂå∫Âüü -->
                        <!-- ‰∏ä‰º†ÊåâÈíÆÂå∫Âüü -->
                        <div class="upload-buttons-row">
                            <div class="upload-btn-group">
                                <button type="button" id="browse-folder-btn" class="upload-folder-btn">
                                    <span class="upload-folder-icon">üì¶</span>
                                    <span class="upload-folder-text">‰∏ä‰º†È°πÁõÆ</span>
                                    <span class="upload-progress-text"></span>
                                    <span class="folder-name"></span>
                                    <span class="delete-text">Âà†Èô§</span>
                                    <span class="cancel-upload-text">ÂèñÊ∂à</span>
                                    <svg class="upload-progress-ring" width="24" height="24" id="upload-progress-ring">
                                        <circle class="progress-ring__track" stroke="#e2e8f0" stroke-width="2"
                                            fill="transparent" r="10" cx="12" cy="12" />
                                        <circle class="progress-ring__circle" stroke="#10b981" stroke-width="2"
                                            fill="transparent" r="10" cx="12" cy="12"
                                            style="stroke-dasharray: 63; stroke-dashoffset: 63;" />
                                    </svg>
                                </button>
                                <div class="upload-dropdown-menu">
                                    <div class="upload-dropdown-item" id="trigger-zip-upload">
                                        <span>üì¶</span> ‰∏ä‰º† ZIP ÂéãÁº©ÂåÖ
                                    </div>
                                    <div class="upload-dropdown-item" id="trigger-folder-upload">
                                        <span>üìÅ</span> ‰∏ä‰º†Êñá‰ª∂Â§π
                                    </div>
                                </div>
                            </div>

                            <button type="button" id="browse-csv-btn" class="upload-csv-btn">
                                <span class="upload-csv-icon">üìã</span>
                                <span class="upload-csv-text">‰∏ä‰º†ÊâπÈáè‰ªªÂä°ÔºàcsvÔºâ</span>
                            </button>
                        </div>

                        <!-- ZIP Input -->
                        <input type="file" id="zip-input" accept=".zip" style="display:none">

                        <div class="model-selection">
                            <h3 style="font-size:0.9rem; margin-bottom:0.5rem; color:#64748b;">ÈÄâÊã©Ê®°Âûã</h3>
                            <div id="model-checkboxes" class="checkbox-group">
                                <!-- Models will be injected here via JS -->
                                <div style="color:#94a3b8; font-size:0.9rem;">Loading models...</div>
                            </div>
                        </div>

                        <button id="add-task-btn" class="btn-primary btn-empty-prompt"
                            style="margin-top:1rem;">ÂêØÂä®‰ªªÂä°</button>
                    </div>
                </div>
            </div>
        </div>

    </div> <!-- End of main-wrapper -->
    </div> <!-- End of app-layout -->

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Floating Comment Button -->
    <button id="floating-comment-btn" class="floating-comment-btn" style="display:none;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round" style="color: #1e293b;">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            <line x1="8" y1="12" x2="16" y2="12"></line>
        </svg>
    </button>

    <!-- Comment Input Popover -->
    <div id="comment-input-popover" class="comment-input-popover" style="display:none;">
        <textarea id="comment-input-text" placeholder="ËØ∑ËæìÂÖ•ËØÑËÆ∫..." rows="3"></textarea>
    </div>

    <!-- Context Menu for Task Items -->
    <div id="item-dropdown-menu" class="item-dropdown-menu">
        <div class="dropdown-item" id="download-task-menu-item">
            <span>üì•</span> ‰∏ãËΩΩËΩ®Ëøπ
        </div>
        <div class="dropdown-item delete" id="delete-task-menu-item">
            <span>üóëÔ∏è</span> Âà†Èô§‰ªªÂä°
        </div>
    </div>

    <!-- Add Feedback Modal -->
    <div id="add-feedback-modal" class="file-preview-modal">
        <div class="preview-content feedback-modal-content">
            <div class="preview-header">
                <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">Êñ∞Â¢ûÂèçÈ¶à</h3>
                <button class="close-btn" onclick="App.comments.closeFeedbackModal()">&times;</button>
            </div>
            <div class="preview-body feedback-modal-body">
                <!-- Hidden element to store current model name for JS -->
                <input type="hidden" id="feedback-model-name" value="">

                <!-- Feedback Text -->
                <div class="feedback-form-group">
                    <label class="feedback-label">ÂèçÈ¶àÂÜÖÂÆπ <span class="required-mark">*</span></label>
                    <textarea id="feedback-content-input" placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÂèçÈ¶àÂÜÖÂÆπ..." rows="6"></textarea>
                </div>

                <!-- Image Upload -->
                <div class="feedback-form-group">
                    <label class="feedback-label">‰∏ä‰º†ÂõæÁâáÔºàÂèØÈÄâÔºâ</label>
                    <div id="feedback-image-preview" class="feedback-image-preview"></div>
                    <label class="feedback-upload-btn">
                        <input type="file" id="feedback-image-input" accept="image/*" multiple style="display: none;"
                            onchange="App.comments.handleImageSelect(event)">
                        <span>üì∑</span> ÁÇπÂáª‰∏ä‰º†ÂõæÁâá
                    </label>
                    <div class="feedback-upload-hint">ÊîØÊåÅ jpg, png, gif, webp Ê†ºÂºèÔºåÊúÄÂ§ö10Âº†</div>
                </div>

                <!-- Submit Button -->
                <button id="submit-feedback-btn" class="btn-primary" onclick="App.comments.submitUserFeedback()">
                    Êèê‰∫§ÂèçÈ¶à
                </button>
            </div>
        </div>
    </div>

    <!-- Ê®°ÂùóÂåñ JS Êñá‰ª∂ -->
    <script src="js/toast.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/app.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/taskHistory.js"></script>
    <script src="js/taskModal.js"></script>
    <script src="js/taskDetails.js"></script>
    <script src="js/views/statsView.js"></script>
    <script src="js/views/compareView.js"></script>
    <script src="js/mainContent.js"></script>
    <script src="js/preview.js"></script>
    <script src="js/feedback.js"></script>
    <script src="js/comments.js"></script>
    <script>
        // ÂàùÂßãÂåñÂ∫îÁî®
        document.addEventListener('DOMContentLoaded', App.init);
    </script>
    <script>
        // Fixed-position tooltip for .preview-info-tip (avoids overflow:hidden clipping)
        (function () {
            let tip = null;
            document.addEventListener('mouseover', function (e) {
                const el = e.target.closest('.preview-info-tip');
                if (!el) return;
                if (tip) tip.remove();
                const text = el.getAttribute('data-tip');
                if (!text) return;
                tip = document.createElement('div');
                tip.textContent = text;
                tip.style.cssText = 'position:fixed;z-index:99999;background:#1e293b;color:#f1f5f9;font-size:12px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;line-height:1.5;padding:6px 10px;border-radius:6px;max-width:320px;pointer-events:none;white-space:normal;';
                document.body.appendChild(tip);
                const rect = el.getBoundingClientRect();
                tip.style.top = (rect.bottom + 6) + 'px';
                tip.style.left = rect.left + 'px';
                // Prevent overflow right
                const tipRect = tip.getBoundingClientRect();
                if (tipRect.right > window.innerWidth - 8) {
                    tip.style.left = (window.innerWidth - tipRect.width - 8) + 'px';
                }
            });
            document.addEventListener('mouseout', function (e) {
                const el = e.target.closest('.preview-info-tip');
                if (el && tip) { tip.remove(); tip = null; }
            });
        })();
    </script>

    <!-- Change Password Modal -->
    <div id="change-password-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
        <div style="background:white; border-radius:1rem; max-width:400px; width:90%; box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);">
            <div style="padding:1.25rem 1.5rem; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="font-size:1.1rem; font-weight:600;">‰øÆÊîπÂØÜÁ†Å</h3>
                <button onclick="closeChangePasswordModal()" style="background:none; border:none; font-size:1.5rem; color:#94a3b8; cursor:pointer;">&times;</button>
            </div>
            <div style="padding:1.5rem;">
                <div id="cp-error" style="background:#fef2f2; color:#dc2626; padding:0.75rem; border-radius:0.5rem; font-size:0.875rem; margin-bottom:1rem; display:none;"></div>
                <div id="cp-success" style="background:#f0fdf4; color:#16a34a; padding:0.75rem; border-radius:0.5rem; font-size:0.875rem; margin-bottom:1rem; display:none;"></div>
                <form id="change-password-form">
                    <div style="margin-bottom:1rem;">
                        <label style="display:block; margin-bottom:0.5rem; font-weight:500; font-size:0.9rem;">ÊóßÂØÜÁ†Å</label>
                        <input type="password" id="cp-old-password" style="width:100%; padding:0.75rem; border:1px solid #e2e8f0; border-radius:0.5rem; font-size:0.9rem;" required>
                    </div>
                    <div style="margin-bottom:1rem;">
                        <label style="display:block; margin-bottom:0.5rem; font-weight:500; font-size:0.9rem;">Êñ∞ÂØÜÁ†Å</label>
                        <input type="password" id="cp-new-password" style="width:100%; padding:0.75rem; border:1px solid #e2e8f0; border-radius:0.5rem; font-size:0.9rem;" required minlength="6">
                    </div>
                    <div style="margin-bottom:1.5rem;">
                        <label style="display:block; margin-bottom:0.5rem; font-weight:500; font-size:0.9rem;">Á°ÆËÆ§Êñ∞ÂØÜÁ†Å</label>
                        <input type="password" id="cp-confirm-password" style="width:100%; padding:0.75rem; border:1px solid #e2e8f0; border-radius:0.5rem; font-size:0.9rem;" required minlength="6">
                    </div>
                    <div style="display:flex; justify-content:flex-end; gap:0.75rem;">
                        <button type="button" onclick="closeChangePasswordModal()" style="padding:0.6rem 1.2rem; border:1px solid #e2e8f0; border-radius:0.5rem; background:white; cursor:pointer; font-size:0.9rem;">ÂèñÊ∂à</button>
                        <button type="submit" id="cp-submit-btn" style="padding:0.6rem 1.2rem; border:none; border-radius:0.5rem; background:#0f172a; color:white; cursor:pointer; font-size:0.9rem; font-weight:500;">Á°ÆËÆ§‰øÆÊîπ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function openChangePasswordModal() {
            const modal = document.getElementById('change-password-modal');
            modal.style.display = 'flex';
            document.getElementById('cp-old-password').value = '';
            document.getElementById('cp-new-password').value = '';
            document.getElementById('cp-confirm-password').value = '';
            document.getElementById('cp-error').style.display = 'none';
            document.getElementById('cp-success').style.display = 'none';
        }

        function closeChangePasswordModal() {
            document.getElementById('change-password-modal').style.display = 'none';
        }

        document.getElementById('change-password-modal').addEventListener('click', function(e) {
            if (e.target === this) closeChangePasswordModal();
        });

        document.getElementById('change-password-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const errorEl = document.getElementById('cp-error');
            const successEl = document.getElementById('cp-success');
            const btn = document.getElementById('cp-submit-btn');
            errorEl.style.display = 'none';
            successEl.style.display = 'none';

            const oldPassword = document.getElementById('cp-old-password').value;
            const newPassword = document.getElementById('cp-new-password').value;
            const confirmPassword = document.getElementById('cp-confirm-password').value;

            if (newPassword.length < 6) {
                errorEl.textContent = 'Êñ∞ÂØÜÁ†ÅÈïøÂ∫¶‰∏çËÉΩÂ∞ë‰∫é 6 ‰Ωç';
                errorEl.style.display = 'block';
                return;
            }

            if (newPassword !== confirmPassword) {
                errorEl.textContent = '‰∏§Ê¨°ËæìÂÖ•ÁöÑÊñ∞ÂØÜÁ†Å‰∏ç‰∏ÄËá¥';
                errorEl.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Êèê‰∫§‰∏≠...';

            try {
                const data = await App.api.changePassword(oldPassword, newPassword);
                if (data.success) {
                    successEl.textContent = 'ÂØÜÁ†Å‰øÆÊîπÊàêÂäü';
                    successEl.style.display = 'block';
                    setTimeout(closeChangePasswordModal, 1500);
                } else {
                    errorEl.textContent = data.error || '‰øÆÊîπÂ§±Ë¥•';
                    errorEl.style.display = 'block';
                }
            } catch (err) {
                errorEl.textContent = 'ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï';
                errorEl.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Á°ÆËÆ§‰øÆÊîπ';
            }
        });
    </script>
</body>

</html>